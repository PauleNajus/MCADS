{% extends 'xrayapp/base.html' %}
{% load xrayapp_extras %}

{% block title %}MCADS Interpretability{% endblock %}

{% block extra_css %}
<style>
    /* Override container width for better visualization display */
    .interpretation-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    /* Add a small indicator for clickable images */
    .visualization-image {
        position: relative;
        transition: transform 0.2s;
        cursor: pointer;
    }
    .visualization-image::after {
        content: 'üîç';
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 14px;
    }
    /* Add styles for raw gradients mode */
    .raw-gradients-mode {
        border: 2px solid #ff5722;
        box-shadow: 0 0 8px rgba(255, 87, 34, 0.5);
    }
    /* Hide canvases used for processing */
    .hidden-canvas {
        display: none !important;
    }
    /* Style for alternative views that are hidden by default */
    .alt-view {
        display: none;
        max-height: 600px;
    }
    
    /* Image metadata table styling */
    .image-metadata-table {
        margin-bottom: 10px;
    }
    
    .image-metadata-table .table-sm td {
        font-size: 8pt !important;
        padding: 4px 6px !important;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    .image-metadata-table .table-sm th {
        font-size: 9pt !important;
        font-weight: 600;
        padding: 6px;
        background-color: #f8f9fa !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="interpretation-container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">MCADS interpretability analysis</h2>
            
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Original X-ray image</h5>
                    <small>Uploaded on {{ xray.uploaded_at|date:"F d, Y H:i" }}</small>
                </div>
                <div class="card-body text-center">
                    <div class="position-relative d-inline-block">
                        <img src="{{ image_url }}" alt="X-ray Image" class="img-fluid" style="max-height: 400px;">
                        <div class="position-absolute bottom-0 end-0 m-2 bg-dark bg-opacity-50 text-white px-2 py-1 rounded small">
                            <i class="bi bi-zoom-in"></i> Click to enlarge
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Interpretability Processing Feedback -->
            <div id="interpretation-progress" class="card mb-4" style="display: none;">
                <div class="card-header">
                    <h4 class="text-center mb-4">Generating visualization...</h4>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="interpretation-progress-bar" 
                             class="progress-bar bg-loading progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%;" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    
                    <p class="text-center">
                        <span id="interpretation-percentage">0%</span> Complete
                    </p>
                    
                    <div class="alert alert-danger mt-4">
                        <p class="mb-0 text-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span id="interpretation-status">Please wait while we generate the visualization</span>
                        </p>
                        <p class="mb-0 text-center mt-2">
                            <strong>Warning! This tool is not meant to be used without supervision of a medical professional!</strong>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Generate interpretability visualizations</h5>
                </div>
                <div class="card-body">
                    <form id="interpretability-form" action="{% url 'generate_interpretability' xray.id %}" method="get" class="mb-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="method" class="form-label">Interpretation Method</label>
                                <select name="method" id="method" class="form-select">
                                    <option value="gradcam">Grad-CAM</option>
                                    <option value="combined_gradcam">Combined Grad-CAM (pathologies > 0.5)</option>
                                    <option value="pli">Pixel-level interpretability</option>
                                    <option value="combined_pli">Combined Pixel-level interpretability (pathologies > 0.5)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="model_type" class="form-label">Model Type</label>
                                <select name="model_type" id="model_type" class="form-select">
                                    <option value="densenet">DenseNet-121</option>
                                    <option value="resnet">ResNet-50</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="target_class" class="form-label">Target Class (optional)</label>
                                <select name="target_class" id="target_class" class="form-select">
                                    <option value="">Use highest probability class</option>
                                    {% for pathology, prob in predictions.items %}
                                    <option value="{{ pathology }}">{{ pathology }} ({{ prob|floatformat:3 }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-outline-secondary">Generate visualization</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="row">
                {% if has_gradcam %}
                <div class="col-md-12">
                    <div class="card mb-4" id="gradcam-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Grad-CAM visualization - {{ gradcam_target }}</h5>
                        </div>
                        <div class="card-body text-center">
                            <!-- Default view -->
                            <div class="row">
                                <div class="col-md-4">
                                    <img id="gradcam-original" src="{{ image_url }}" alt="Original X-ray" class="img-fluid visualization-image" style="max-height: 600px;">
                                    <p class="mt-2 text-center">Original X-ray</p>
                                </div>
                                <div class="col-md-4">
                                    {% if gradcam_heatmap_url %}
                                    <img id="gradcam-heatmap" src="{{ gradcam_heatmap_url }}?t={% now 'U' %}" alt="Grad-CAM Heatmap" class="img-fluid visualization-image" data-original-src="{{ gradcam_heatmap_url }}" style="max-height: 600px;">
                                    {% else %}
                                    <div class="alert alert-warning">Heatmap not available</div>
                                    {% endif %}
                                    <p class="mt-2 text-center">Grad-CAM heatmap</p>
                                </div>
                                <div class="col-md-4">
                                    {% if gradcam_overlay_url %}
                                    <img id="gradcam-overlay" src="{{ gradcam_overlay_url }}?t={% now 'U' %}" alt="Grad-CAM Overlay" class="img-fluid visualization-image" data-original-src="{{ gradcam_overlay_url }}" style="max-height: 600px;">
                                    {% else %}
                                    <div class="alert alert-warning">Overlay not available</div>
                                    {% endif %}
                                    <p class="mt-2 text-center">Grad-CAM overlay</p>
                                </div>
                            </div>
                            
                            <!-- Raw gradients view (hidden by default) -->
                            {% if gradcam_url %}
                            <img id="gradcam-raw" src="{{ gradcam_url }}?t={% now 'U' %}" alt="Grad-CAM Raw Gradients" class="img-fluid visualization-image alt-view" data-original-src="{{ gradcam_url }}" style="filter: hue-rotate(120deg) saturate(3) contrast(1.5);">
                            {% endif %}
                            
                            <p class="mt-2 text-muted">
                                Grad-CAM highlights the regions in the image that strongly influenced the model's prediction 
                                for {{ gradcam_target }}.
                            </p>
                            
                            <!-- Image Metadata -->
                            <div class="mt-2 mb-2 image-metadata-table">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th colspan="{{ image_metadata|length }}" class="text-center">Image Metadata</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                {% for field, value in image_metadata.items %}
                                                <td><strong>{{ field }}:</strong> {{ value|default:"Unknown" }}</td>
                                                {% endfor %}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="btn-group mt-2">
                                <button class="btn btn-sm btn-outline-secondary invert-btn">Invert colors</button>
                                <button class="btn btn-sm btn-outline-secondary raw-gradients-btn" data-target="gradcam">Raw gradients</button>
                                <button class="btn btn-sm btn-outline-secondary reset-btn" data-target="gradcam">Reset layers</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if has_pli %}
                <div class="col-md-12">
                    <div class="card mb-4" id="pli-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Pixel-level interpretability - {{ pli_target }}</h5>
                        </div>
                        <div class="card-body text-center">
                            <!-- Default view -->
                            <div class="row">
                                <div class="col-md-4">
                                    <img id="pli-original" src="{{ image_url }}" alt="Original X-ray" class="img-fluid visualization-image" style="max-height: 600px;">
                                    <p class="mt-2 text-center">Original X-ray</p>
                                </div>
                                <div class="col-md-4">
                                    {% if pli_saliency_url %}
                                    <img id="pli-saliency" src="{{ pli_saliency_url }}?t={% now 'U' %}" alt="Pixel Saliency Map" class="img-fluid visualization-image" data-original-src="{{ pli_saliency_url }}" style="max-height: 600px;">
                                    {% else %}
                                    <div class="alert alert-warning">Saliency map not available</div>
                                    {% endif %}
                                    <p class="mt-2 text-center">Pixel saliency pap</p>
                                </div>
                                <div class="col-md-4">
                                    {% if pli_overlay_url %}
                                    <img id="pli-overlay" src="{{ pli_overlay_url }}?t={% now 'U' %}" alt="Pixel-Level Overlay" class="img-fluid visualization-image" data-original-src="{{ pli_overlay_url }}" style="max-height: 600px; filter: opacity(1);">
                                    {% else %}
                                    <div class="alert alert-warning">Overlay not available</div>
                                    {% endif %}
                                    <p class="mt-2 text-center">Pixel-level overlay</p>
                                </div>
                            </div>
                            
                            <!-- Raw gradients view (hidden by default) -->
                            {% if pli_url %}
                            <img id="pli-raw" src="{{ pli_url }}?t={% now 'U' %}" alt="PLI Raw Gradients" class="img-fluid visualization-image alt-view" data-original-src="{{ pli_url }}" style="filter: hue-rotate(120deg) saturate(3) contrast(1.5);">
                            {% endif %}
                            
                            <p class="mt-3 text-muted">
                                Pixel-Level Interpretability shows which individual pixels had the most influence 
                                on the model's prediction for {{ pli_target }}.
                            </p>
                            
                            <!-- Image Metadata -->
                            <div class="mt-2 mb-2 image-metadata-table">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th colspan="{{ image_metadata|length }}" class="text-center">Image Metadata</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                {% for field, value in image_metadata.items %}
                                                <td><strong>{{ field }}:</strong> {{ value|default:"Unknown" }}</td>
                                                {% endfor %}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="btn-group mt-2">
                                <button class="btn btn-sm btn-outline-secondary invert-btn">Invert colors</button>
                                <button class="btn btn-sm btn-outline-secondary raw-gradients-btn" data-target="pli">Raw gradients</button>
                                <button class="btn btn-sm btn-outline-secondary reset-btn" data-target="pli">Reset layers</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Prediction results</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Pathology</th>
                                <th style="width: 45%;">Probability</th>
                                <th style="width: 20%;">Visualize</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pathology, prob in predictions.items %}
                            <tr>
                                <td style="width: 35%;">
                                    {{ pathology }}
                                    <button type="button" class="btn-info-pathology ms-2" data-pathology="{{ pathology }}" title="Learn more about {{ pathology }}">
                                        <i class="fas fa-question-circle"></i>
                                    </button>
                                </td>
                                <td style="width: 45%;">
                                    <div class="progress position-relative" style="min-width: 200px;">
                                        <div class="progress-bar {% if prob >= 0.45 and prob <= 0.55 %}bg-warning{% elif prob > 0.5 %}bg-danger{% else %}bg-success{% endif %}" 
                                             role="progressbar" 
                                             data-probability="{{ prob|percentage }}"
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                        <span class="progress-text">{{ prob|floatformat:3 }}</span>
                                    </div>
                                </td>
                                <td style="width: 20%;">
                                    <a href="{% url 'generate_interpretability' xray.id %}?method=gradcam&target_class={{ pathology }}" 
                                       class="btn btn-sm btn-outline-secondary interpretation-btn" data-method="gradcam">
                                        Grad-CAM
                                    </a>
                                    <a href="{% url 'generate_interpretability' xray.id %}?method=pli&target_class={{ pathology }}" 
                                       class="btn btn-sm btn-outline-secondary interpretation-btn" data-method="pli">
                                        PLI
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center mb-5">
                <a href="{% url 'xray_results' xray.id %}" class="btn btn-outline-secondary">Back to results</a>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">Upload new X-ray</a>
            </div>
        </div>
    </div>
</div>

<!-- Pathology Explanation Modal -->
<div class="modal fade" id="pathologyModal" tabindex="-1" aria-labelledby="pathologyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pathologyModalLabel">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="pathologyName">Pathology Information</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Medical Disclaimer:</strong>
                    Always consult with a qualified healthcare professional for proper medical evaluation and treatment.
                </div>
                <p id="pathologyDescription" class="text-justify">
                    <!-- Pathology description will be inserted here -->
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

{{ pathology_explanations|json_script:"pathology-data" }}
{{ xray.id|json_script:"xray-id" }}
<script>
const XRAY_ID = JSON.parse(document.getElementById('xray-id').textContent);
document.addEventListener('DOMContentLoaded', () => {
    // Set progress bar widths and aria values from data attributes
    const progressBars = document.querySelectorAll('.progress-bar[data-probability]');
    progressBars.forEach(bar => {
        const percentage = bar.getAttribute('data-probability');
        bar.style.width = percentage + '%';
        bar.setAttribute('aria-valuenow', percentage);
    });
    
    // Pathology explanations data
    const pathologyExplanations = JSON.parse(document.getElementById('pathology-data').textContent);
    
    // Handle pathology info button clicks
    document.querySelectorAll('.btn-info-pathology').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const pathology = this.getAttribute('data-pathology');
            const explanation = pathologyExplanations[pathology];
            
            if (explanation) {
                document.getElementById('pathologyName').textContent = pathology;
                document.getElementById('pathologyDescription').textContent = explanation;
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('pathologyModal'));
                modal.show();
            }
        });
    });
    
    const interpretationForm = document.getElementById('interpretability-form');
    const interpretationButtons = document.querySelectorAll('.interpretation-btn');
    const progressWrapper = document.getElementById('interpretation-progress');
    const progressBar = document.getElementById('interpretation-progress-bar');
    const statusText = document.getElementById('interpretation-status');
    const percentageText = document.getElementById('interpretation-percentage');
    
    // Initialize visualization control buttons
    const invertButtons = document.querySelectorAll('.invert-btn');
    const rawGradientsButtons = document.querySelectorAll('.raw-gradients-btn');
    const resetButtons = document.querySelectorAll('.reset-btn');
    
    // Make visualization images expandable
    const visualizationImages = document.querySelectorAll('.visualization-image');
    visualizationImages.forEach(img => {
        img.style.cursor = 'pointer';
        
        // Add click event listener to each visualization image
        img.addEventListener('click', function() {
            // Create overlay elements
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '9999';
            overlay.style.cursor = 'zoom-out';
            
            // Create expanded image
            const expandedImg = document.createElement('img');
            expandedImg.src = this.src;
            expandedImg.style.maxHeight = '90vh';
            expandedImg.style.maxWidth = '90vw';
            expandedImg.style.objectFit = 'contain';
            
            // Copy the filter style from the original image to preserve effects like invert
            if (this.style.filter) {
                expandedImg.style.filter = this.style.filter;
            }
            
            // Add close functionality
            overlay.addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
            
            // Prevent click on image from closing the overlay
            expandedImg.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Add keyboard navigation (Escape to close)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
            });
            
            // Append elements to the body
            overlay.appendChild(expandedImg);
            document.body.appendChild(overlay);
        });
    });
    
    // Add form submission handler
    if (interpretationForm) {
        interpretationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show progress container
            progressWrapper.style.display = 'block';
            
            // Get the method and target class
            const method = document.getElementById('method').value;
            const targetClass = document.getElementById('target_class').value;
            const modelType = document.getElementById('model_type').value;
            
            // Update status text
            statusText.textContent = `Generating ${method === 'gradcam' ? 'Grad-CAM' : 'Pixel-Level Interpretability'} visualization...`;
            
            // Build the URL
            let url = this.action + '?method=' + method;
            if (targetClass) {
                url += '&target_class=' + encodeURIComponent(targetClass);
            }
            if (modelType) {
                url += '&model_type=' + encodeURIComponent(modelType);
            }
            
            // Fetch the URL to start the process
            fetch(url)
                .then(response => {
                    // Start monitoring progress
                    monitorProgress();
                })
                .catch(error => {
                    console.error('Error starting interpretation:', error);
                    statusText.textContent = 'Error starting interpretation process';
                });
        });
    }
    
    // Add click event listeners to interpretation buttons
    interpretationButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show progress container
            progressWrapper.style.display = 'block';
            
            // Get the URL from the button
            const url = this.getAttribute('href');
            const methodName = this.dataset.method;
            
            // Update status text
            statusText.textContent = `Generating ${methodName === 'gradcam' ? 'Grad-CAM' : 'Pixel-Level Interpretability'} visualization...`;
            
            // Fetch the URL to start the process
            fetch(url)
                .then(response => {
                    // Start monitoring progress
                    monitorProgress();
                })
                .catch(error => {
                    console.error('Error starting interpretation:', error);
                    statusText.textContent = 'Error starting interpretation process';
                });
        });
    });
    
    function monitorProgress() {
        let progress = 5;
        progressBar.style.width = `${progress}%`;
        percentageText.textContent = `${progress}%`;
        
        // Check progress from the server
        function checkProgress() {
            fetch(`/progress/${XRAY_ID}/`)
                .then(response => response.json())
                .then(data => {
                    progress = data.progress;
                    progressBar.style.width = `${progress}%`;
                    percentageText.textContent = `${progress}%`;
                    
                    if (progress < 100) {
                        // Check again in 500ms
                        setTimeout(checkProgress, 500);
                    } else {
                        // Complete - redirect to view page after a short delay
                        statusText.textContent = 'Visualization complete! Reloading...';
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                    statusText.textContent = 'Error checking progress';
                });
        }
        
        // Start checking progress
        checkProgress();
    }
    
    // Add invert colors functionality
    invertButtons.forEach(button => {
        button.addEventListener('click', function() {
            const cardBody = this.closest('.card-body');
            
            // For PLI with multiple images
            if (cardBody.querySelector('#pli-saliency')) {
                // For PLI with separate panels
                const saliencyImg = cardBody.querySelector('#pli-saliency');
                const overlayImg = cardBody.querySelector('#pli-overlay');
                
                // Invert saliency map
                saliencyImg.style.filter = saliencyImg.style.filter.includes('invert(1)') ? '' : 'invert(1)';
                
                // Invert overlay
                overlayImg.style.filter = overlayImg.style.filter.includes('invert(1)') ? '' : 'invert(1)';
            } else if (cardBody.querySelector('#gradcam-heatmap')) {
                // For GradCAM with separate panels
                const heatmapImg = cardBody.querySelector('#gradcam-heatmap');
                const overlayImg = cardBody.querySelector('#gradcam-overlay');
                
                // Invert heatmap
                heatmapImg.style.filter = heatmapImg.style.filter.includes('invert(1)') ? '' : 'invert(1)';
                
                // Invert overlay
                overlayImg.style.filter = overlayImg.style.filter.includes('invert(1)') ? '' : 'invert(1)';
            } else {
                // For other visualizations with a single image
                const img = cardBody.querySelector('img:not(.alt-view)');
                img.style.filter = img.style.filter.includes('invert(1)') ? '' : 'invert(1)';
            }
        });
    });
    
    // Add raw gradients functionality
    rawGradientsButtons.forEach(button => {
        button.addEventListener('click', function() {
            const target = this.dataset.target;
            
            if (target === 'pli') {
                // For PLI with separate panels
                const originalImg = document.getElementById('pli-original');
                const saliencyImg = document.getElementById('pli-saliency');
                const overlayImg = document.getElementById('pli-overlay');
                const rawImg = document.getElementById('pli-raw');
                
                if (saliencyImg.style.display === 'none') {
                    // Switch to default view
                    originalImg.parentElement.style.display = 'block';
                    saliencyImg.parentElement.style.display = 'block';
                    overlayImg.parentElement.style.display = 'block';
                    rawImg.style.display = 'none';
                    this.textContent = 'Raw gradients';
                    this.classList.remove('active');
                } else {
                    // Switch to raw gradients view
                    originalImg.parentElement.style.display = 'none';
                    saliencyImg.parentElement.style.display = 'none';
                    overlayImg.parentElement.style.display = 'none';
                    rawImg.style.display = 'inline-block';
                    this.textContent = 'Normal view';
                    this.classList.add('active');
                }
            } else {
                // For GradCAM with separate panels
                const originalImg = document.getElementById('gradcam-original');
                const heatmapImg = document.getElementById('gradcam-heatmap');
                const overlayImg = document.getElementById('gradcam-overlay');
                const rawImg = document.getElementById('gradcam-raw');
                
                if (heatmapImg.style.display === 'none') {
                    // Switch to default view
                    originalImg.parentElement.style.display = 'block';
                    heatmapImg.parentElement.style.display = 'block';
                    overlayImg.parentElement.style.display = 'block';
                    rawImg.style.display = 'none';
                    this.textContent = 'Raw gradients';
                    this.classList.remove('active');
                } else {
                    // Switch to raw gradients view
                    originalImg.parentElement.style.display = 'none';
                    heatmapImg.parentElement.style.display = 'none';
                    overlayImg.parentElement.style.display = 'none';
                    rawImg.style.display = 'inline-block';
                    this.textContent = 'Normal view';
                    this.classList.add('active');
                }
            }
        });
    });
    
    // Add reset functionality
    resetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const target = this.dataset.target;
            
            if (target === 'pli') {
                // For PLI with separate panels
                const originalImg = document.getElementById('pli-original');
                const saliencyImg = document.getElementById('pli-saliency');
                const overlayImg = document.getElementById('pli-overlay');
                const rawImg = document.getElementById('pli-raw');
                
                // Show default images
                originalImg.parentElement.style.display = 'block';
                saliencyImg.parentElement.style.display = 'block';
                overlayImg.parentElement.style.display = 'block';
                rawImg.style.display = 'none';
                
                // Reset filters
                saliencyImg.style.filter = '';
                overlayImg.style.filter = '';
                rawImg.style.filter = 'hue-rotate(120deg) saturate(3) contrast(1.5)';
                
                // Reset button states
                const rawBtn = this.previousElementSibling;
                rawBtn.textContent = 'Raw gradients';
                rawBtn.classList.remove('active');
            } else {
                // For GradCAM with separate panels
                const originalImg = document.getElementById('gradcam-original');
                const heatmapImg = document.getElementById('gradcam-heatmap');
                const overlayImg = document.getElementById('gradcam-overlay');
                const rawImg = document.getElementById('gradcam-raw');
                
                // Show default images
                originalImg.parentElement.style.display = 'block';
                heatmapImg.parentElement.style.display = 'block';
                overlayImg.parentElement.style.display = 'block';
                rawImg.style.display = 'none';
                
                // Reset filters
                heatmapImg.style.filter = '';
                overlayImg.style.filter = '';
                rawImg.style.filter = 'hue-rotate(120deg) saturate(3) contrast(1.5)';
                
                // Reset button states
                const rawBtn = this.previousElementSibling;
                rawBtn.textContent = 'Raw gradients';
                rawBtn.classList.remove('active');
            }
        });
    });
});
</script>
{% endblock %} 