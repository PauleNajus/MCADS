{% extends 'xrayapp/base.html' %}
{% load xrayapp_extras %}

{% block title %}LDCS Interpretability{% endblock %}

{% block extra_css %}
<style>
    /* Override container width for better visualization display */
    .interpretation-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    /* Add a small indicator for clickable images */
    .visualization-image {
        position: relative;
        transition: transform 0.2s;
        cursor: pointer;
    }
    .visualization-image::after {
        content: 'üîç';
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 14px;
    }
    /* Add styles for raw gradients mode */
    .raw-gradients-mode {
        border: 2px solid #ff5722;
        box-shadow: 0 0 8px rgba(255, 87, 34, 0.5);
    }
    /* Hide canvases used for processing */
    .hidden-canvas {
        display: none !important;
    }
    /* Style for alternative views that are hidden by default */
    .alt-view {
        display: none;
        max-height: 600px;
    }
</style>
{% endblock %}

{% block content %}
<div class="interpretation-container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">LDCS Interpretability Analysis</h2>
            
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Original X-ray Image</h5>
                    <small>Uploaded on {{ xray.uploaded_at|date:"F d, Y H:i" }}</small>
                </div>
                <div class="card-body text-center">
                    <div class="position-relative d-inline-block">
                        <img src="{{ image_url }}" alt="X-ray Image" class="img-fluid" style="max-height: 400px;">
                        <div class="position-absolute bottom-0 end-0 m-2 bg-dark bg-opacity-50 text-white px-2 py-1 rounded small">
                            <i class="bi bi-zoom-in"></i> Click to enlarge
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Interpretability Processing Feedback -->
            <div id="interpretation-progress" class="card mb-4" style="display: none;">
                <div class="card-header">
                    <h4 class="text-center mb-4">Generating Visualization...</h4>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="interpretation-progress-bar" 
                             class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%;" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    
                    <p class="text-center">
                        <span id="interpretation-percentage">0%</span> Complete
                    </p>
                    
                    <div class="alert alert-info mt-4">
                        <p class="mb-0 text-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <span id="interpretation-status">Please wait while we generate the visualization</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Generate Interpretability Visualizations</h5>
                </div>
                <div class="card-body">
                    <form id="interpretability-form" action="{% url 'generate_interpretability' xray.id %}" method="get" class="mb-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="method" class="form-label">Interpretation Method</label>
                                <select name="method" id="method" class="form-select">
                                    <option value="gradcam">Grad-CAM</option>
                                    <option value="pli">Pixel-Level Interpretability</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="model_type" class="form-label">Model Type</label>
                                <select name="model_type" id="model_type" class="form-select">
                                    <option value="densenet">DenseNet-121</option>
                                    <option value="resnet">ResNet-50</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="target_class" class="form-label">Target Class (optional)</label>
                                <select name="target_class" id="target_class" class="form-select">
                                    <option value="">Use highest probability class</option>
                                    {% for pathology, prob in predictions.items %}
                                    <option value="{{ pathology }}">{{ pathology }} ({{ prob|floatformat:3 }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-outline-secondary">Generate Visualization</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="row">
                {% if has_gradcam %}
                <div class="col-md-12">
                    <div class="card mb-4" id="gradcam-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Grad-CAM Visualization - {{ gradcam_target }}</h5>
                        </div>
                        <div class="card-body text-center">
                            <!-- Default view -->
                            <img id="gradcam-default" src="{{ gradcam_url }}?t={% now 'U' %}" alt="Grad-CAM Visualization" class="img-fluid visualization-image" data-original-src="{{ gradcam_url }}" style="max-height: 600px;">
                            
                            <!-- Raw gradients view (hidden by default) -->
                            <img id="gradcam-raw" src="{{ gradcam_url }}?t={% now 'U' %}" alt="Grad-CAM Raw Gradients" class="img-fluid visualization-image alt-view" data-original-src="{{ gradcam_url }}" style="filter: hue-rotate(120deg) saturate(3) contrast(1.5);">
                            
                            <p class="mt-2 text-muted">
                                Grad-CAM highlights the regions in the image that strongly influenced the model's prediction 
                                for {{ gradcam_target }}.
                            </p>
                            
                            <!-- Image Metadata -->
                            <div class="mt-2 mb-2">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th colspan="4" class="text-center">Image Metadata</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                {% for field, value in image_metadata.items %}
                                                <td><strong>{{ field }}:</strong> {{ value|default:"Unknown" }}</td>
                                                {% endfor %}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="btn-group mt-2">
                                <button class="btn btn-sm btn-outline-secondary invert-btn">Invert colors</button>
                                <button class="btn btn-sm btn-outline-secondary raw-gradients-btn" data-target="gradcam">Raw gradients</button>
                                <button class="btn btn-sm btn-outline-secondary reset-btn" data-target="gradcam">Reset layers</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if has_pli %}
                <div class="col-md-12">
                    <div class="card mb-4" id="pli-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Pixel-Level Interpretability - {{ pli_target }}</h5>
                        </div>
                        <div class="card-body text-center">
                            <!-- Default view -->
                            <img id="pli-default" src="{{ pli_url }}?t={% now 'U' %}" alt="Pixel-Level Interpretability" class="img-fluid visualization-image" data-original-src="{{ pli_url }}" style="max-height: 600px;">
                            
                            <!-- Raw gradients view (hidden by default) -->
                            <img id="pli-raw" src="{{ pli_url }}?t={% now 'U' %}" alt="PLI Raw Gradients" class="img-fluid visualization-image alt-view" data-original-src="{{ pli_url }}" style="filter: hue-rotate(120deg) saturate(3) contrast(1.5);">
                            
                            <p class="mt-2 text-muted">
                                Pixel-Level Interpretability shows which individual pixels had the most influence 
                                on the model's prediction for {{ pli_target }}.
                            </p>
                            
                            <!-- Image Metadata -->
                            <div class="mt-2 mb-2">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th colspan="4" class="text-center">Image Metadata</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                {% for field, value in image_metadata.items %}
                                                <td><strong>{{ field }}:</strong> {{ value|default:"Unknown" }}</td>
                                                {% endfor %}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="btn-group mt-2">
                                <button class="btn btn-sm btn-outline-secondary invert-btn">Invert colors</button>
                                <button class="btn btn-sm btn-outline-secondary raw-gradients-btn" data-target="pli">Raw gradients</button>
                                <button class="btn btn-sm btn-outline-secondary reset-btn" data-target="pli">Reset layers</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Prediction Results</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Pathology</th>
                                <th>Probability</th>
                                <th>Visualize</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pathology, prob in predictions.items %}
                            <tr>
                                <td>{{ pathology }}</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar {% if prob > 0.5 %}bg-danger{% else %}bg-success{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ prob|multiply:100 }}%" 
                                             aria-valuenow="{{ prob|multiply:100 }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ prob|floatformat:3 }}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <a href="{% url 'generate_interpretability' xray.id %}?method=gradcam&target_class={{ pathology }}" 
                                       class="btn btn-sm btn-outline-secondary interpretation-btn" data-method="gradcam">
                                        Grad-CAM
                                    </a>
                                    <a href="{% url 'generate_interpretability' xray.id %}?method=pli&target_class={{ pathology }}" 
                                       class="btn btn-sm btn-outline-secondary interpretation-btn" data-method="pli">
                                        PLI
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center mb-5">
                <a href="{% url 'xray_results' xray.id %}" class="btn btn-outline-secondary">Back to Results</a>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">Upload New X-ray</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const interpretationForm = document.getElementById('interpretability-form');
    const interpretationButtons = document.querySelectorAll('.interpretation-btn');
    const progressWrapper = document.getElementById('interpretation-progress');
    const progressBar = document.getElementById('interpretation-progress-bar');
    const statusText = document.getElementById('interpretation-status');
    const percentageText = document.getElementById('interpretation-percentage');
    
    // Initialize visualization control buttons
    const invertButtons = document.querySelectorAll('.invert-btn');
    const rawGradientsButtons = document.querySelectorAll('.raw-gradients-btn');
    const resetButtons = document.querySelectorAll('.reset-btn');
    
    // Make visualization images expandable
    const visualizationImages = document.querySelectorAll('.visualization-image');
    visualizationImages.forEach(img => {
        img.style.cursor = 'pointer';
        
        // Add click event listener to each visualization image
        img.addEventListener('click', function() {
            // Create overlay elements
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '9999';
            overlay.style.cursor = 'zoom-out';
            
            // Create expanded image
            const expandedImg = document.createElement('img');
            expandedImg.src = this.src;
            expandedImg.style.maxHeight = '90vh';
            expandedImg.style.maxWidth = '90vw';
            expandedImg.style.objectFit = 'contain';
            
            // Copy the filter style from the original image to preserve effects like invert
            if (this.style.filter) {
                expandedImg.style.filter = this.style.filter;
            }
            
            // Add close functionality
            overlay.addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
            
            // Prevent click on image from closing the overlay
            expandedImg.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Add keyboard navigation (Escape to close)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
            });
            
            // Append elements to the body
            overlay.appendChild(expandedImg);
            document.body.appendChild(overlay);
        });
    });
    
    // Add form submission handler
    if (interpretationForm) {
        interpretationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show progress container
            progressWrapper.style.display = 'block';
            
            // Get the method and target class
            const method = document.getElementById('method').value;
            const targetClass = document.getElementById('target_class').value;
            const modelType = document.getElementById('model_type').value;
            
            // Update status text
            statusText.textContent = `Generating ${method === 'gradcam' ? 'Grad-CAM' : 'Pixel-Level Interpretability'} visualization...`;
            
            // Build the URL
            let url = this.action + '?method=' + method;
            if (targetClass) {
                url += '&target_class=' + encodeURIComponent(targetClass);
            }
            if (modelType) {
                url += '&model_type=' + encodeURIComponent(modelType);
            }
            
            // Fetch the URL to start the process
            fetch(url)
                .then(response => {
                    // Start monitoring progress
                    monitorProgress();
                })
                .catch(error => {
                    console.error('Error starting interpretation:', error);
                    statusText.textContent = 'Error starting interpretation process';
                });
        });
    }
    
    // Add click event listeners to interpretation buttons
    interpretationButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show progress container
            progressWrapper.style.display = 'block';
            
            // Get the URL from the button
            const url = this.getAttribute('href');
            const methodName = this.dataset.method;
            
            // Update status text
            statusText.textContent = `Generating ${methodName === 'gradcam' ? 'Grad-CAM' : 'Pixel-Level Interpretability'} visualization...`;
            
            // Fetch the URL to start the process
            fetch(url)
                .then(response => {
                    // Start monitoring progress
                    monitorProgress();
                })
                .catch(error => {
                    console.error('Error starting interpretation:', error);
                    statusText.textContent = 'Error starting interpretation process';
                });
        });
    });
    
    function monitorProgress() {
        let progress = 5;
        progressBar.style.width = `${progress}%`;
        percentageText.textContent = `${progress}%`;
        
        // Check progress from the server
        function checkProgress() {
            fetch(`/progress/{{ xray.id }}/`)
                .then(response => response.json())
                .then(data => {
                    progress = data.progress;
                    progressBar.style.width = `${progress}%`;
                    percentageText.textContent = `${progress}%`;
                    
                    if (progress < 100) {
                        // Check again in 500ms
                        setTimeout(checkProgress, 500);
                    } else {
                        // Complete - redirect to view page after a short delay
                        statusText.textContent = 'Visualization complete! Reloading...';
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                    statusText.textContent = 'Error checking progress';
                });
        }
        
        // Start checking progress
        checkProgress();
    }
    
    // Add invert colors functionality
    invertButtons.forEach(button => {
        button.addEventListener('click', function() {
            const img = this.closest('.card-body').querySelector('img:not(.alt-view)');
            img.style.filter = img.style.filter.includes('invert(1)') ? '' : 'invert(1)';
        });
    });
    
    // Add raw gradients functionality
    rawGradientsButtons.forEach(button => {
        button.addEventListener('click', function() {
            const target = this.dataset.target;
            const defaultImg = document.getElementById(`${target}-default`);
            const rawImg = document.getElementById(`${target}-raw`);
            
            if (defaultImg.style.display === 'none') {
                // Switch to default view
                defaultImg.style.display = 'inline-block';
                rawImg.style.display = 'none';
                this.textContent = 'Raw gradients';
                this.classList.remove('active');
            } else {
                // Switch to raw gradients view
                defaultImg.style.display = 'none';
                rawImg.style.display = 'inline-block';
                this.textContent = 'Overlay view';
                this.classList.add('active');
            }
        });
    });
    
    // Add reset functionality
    resetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const target = this.dataset.target;
            const defaultImg = document.getElementById(`${target}-default`);
            const rawImg = document.getElementById(`${target}-raw`);
            
            // Show default image
            defaultImg.style.display = 'inline-block';
            rawImg.style.display = 'none';
            
            // Reset filters
            defaultImg.style.filter = '';
            rawImg.style.filter = 'hue-rotate(120deg) saturate(3) contrast(1.5)';
            
            // Reset button states
            const rawBtn = this.previousElementSibling;
            rawBtn.textContent = 'Raw gradients';
            rawBtn.classList.remove('active');
        });
    });
});
</script>
{% endblock %} 