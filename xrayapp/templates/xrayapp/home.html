{% extends 'xrayapp/base.html' %}

{% block title %}MCADS - X-Ray Upload{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="text-center fs-4 mb-0">MCADS</h2>
            </div>
            <div class="card-body">
                <!-- Form Wrapper - Will be hidden during processing -->
                <div id="form-wrapper">
                    <p class="lead text-center mb-4">
                        Upload a chest X-ray image for automatic analysis using a pre-trained model
                        from TorchXRayVision.
                    </p>
                    
                    <form method="post" enctype="multipart/form-data" class="mb-4" id="analysis-form">
                        {% csrf_token %}
                        
                        <!-- Model Selection Toggle -->
                        <div class="mb-3">
                            <label class="form-label">Select Model:</label>
                            <div class="btn-group w-100" role="group" aria-label="Model selection">
                                <input type="radio" class="btn-check" name="model_type" id="densenet_model" value="densenet" checked>
                                <label class="btn btn-outline-secondary" for="densenet_model">DenseNet (224px, All Classes)</label>
                                
                                <input type="radio" class="btn-check" name="model_type" id="resnet_model" value="resnet">
                                <label class="btn btn-outline-secondary" for="resnet_model">ResNet (512px, Filtered Classes)</label>
                            </div>
                            <div class="form-text">
                                DenseNet: All 18 pathologies included<br>
                                ResNet: All pathologies except "Enlarged Cardiomediastinum" and "Lung Lesion"
                            </div>
                        </div>
                        
                        <!-- Patient Information Section -->
                        <div class="card mb-3">
                            <div class="card-header">
                                Patient Information
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_first_name" class="form-label">First Name:</label>
                                        <input type="text" name="first_name" id="id_first_name" class="form-control">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_last_name" class="form-label">Last Name:</label>
                                        <input type="text" name="last_name" id="id_last_name" class="form-control">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_patient_id" class="form-label">Patient ID:</label>
                                        <input type="text" name="patient_id" id="id_patient_id" class="form-control">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_gender" class="form-label">Gender:</label>
                                        <select name="gender" id="id_gender" class="form-select">
                                            <option value="">--Select--</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_date_of_birth" class="form-label">Date of Birth:</label>
                                        <input type="date" name="date_of_birth" id="id_date_of_birth" class="form-control">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_date_of_xray" class="form-label">Date of X-ray:</label>
                                        <input type="date" name="date_of_xray" id="id_date_of_xray" class="form-control" value="{{ today_date|date:'Y-m-d' }}">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="id_additional_info" class="form-label">Additional Information:</label>
                                    <textarea name="additional_info" id="id_additional_info" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_image" class="form-label">Select X-ray Image:</label>
                            <input type="file" name="image" id="id_image" accept="image/*" class="form-control" required>
                            <div class="form-text">Supported formats: JPG, PNG, DICOM</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-secondary">Analyze X-Ray</button>
                        </div>
                    </form>
                    
                    <div class="alert alert-warning">
                        <p class="mb-0"><strong>Warning!</strong> This tool is not meant to be used without supervision of a medical professional. Use DenseNet model for best results.</p>
                    </div>
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'prediction_history' %}" class="btn btn-outline-secondary">View Prediction History</a>
                    </div>
                </div>
                
                <!-- Progress Wrapper - Hidden initially, shown during processing -->
                <div id="progress-wrapper" style="display: none;">
                    <h4 class="text-center mb-4">Analyzing X-Ray Image</h4>
                    
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="analysis-progress-bar" 
                             class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%;" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    
                    <p class="text-center">
                        <span id="progress-percentage">0%</span> Complete
                    </p>
                    
                    <div class="alert alert-info mt-4">
                        <p class="mb-0 text-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Please wait while the model analyzes your X-ray image
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'xrayapp/js/analysis.js' %}?v=1.0.1"></script>
<script>
  // Register service worker to clean cache
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("{% static 'xrayapp/js/service-worker.js' %}?v=1.0.1")
      .then(reg => console.log('Service Worker registered:', reg))
      .catch(err => console.error('Service Worker registration failed:', err));
  }
  
  // Set today's date as default for X-ray date
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const dateField = document.getElementById('id_date_of_xray');
    if (dateField && !dateField.value) {
      const formattedDate = today.toISOString().split('T')[0];
      dateField.value = formattedDate;
    }
  });
</script>
{% endblock %} 